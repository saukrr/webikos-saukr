<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zapomenuté heslo - Webikos</title>
    <link rel="stylesheet" href="../css/auth.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="csrf-token" content="">
</head>
<body>
    <div class="auth-container">
        <div class="auth-header">
            <div class="auth-logo">
                <i class="fas fa-key"></i>
            </div>
            <h1 class="auth-title">Zapomenuté heslo</h1>
            <p class="auth-subtitle">Zadejte svůj e-mail pro obnovení hesla</p>
        </div>

        <form class="auth-form" id="forgotPasswordForm">
            <div class="alert alert-error" id="errorAlert"></div>
            <div class="alert alert-success" id="successAlert"></div>

            <!-- Email Input -->
            <div class="form-group">
                <label for="email" class="form-label">E-mailová adresa</label>
                <div class="input-group">
                    <i class="fas fa-envelope input-icon"></i>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="form-input" 
                        placeholder="vas@email.com"
                        required
                        autocomplete="email"
                    >
                </div>
                <div class="form-error" id="emailError"></div>
                <div class="form-help">Pošleme vám odkaz pro obnovení hesla</div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary" id="resetBtn">
                <span class="loading-spinner" id="resetSpinner"></span>
                <span id="resetBtnText">Odeslat odkaz</span>
            </button>

            <!-- CSRF Token -->
            <input type="hidden" name="_token" id="csrfToken">
        </form>

        <div class="auth-footer">
            <p>Vzpomněli jste si? <a href="login.html">Přihlaste se</a></p>
            <p>Nemáte účet? <a href="register.html">Zaregistrujte se</a></p>
            <p><a href="../../../index.html">← Zpět na hlavní stránku</a></p>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script>
        class ForgotPasswordManager {
            constructor() {
                this.form = document.getElementById('forgotPasswordForm');
                this.resetBtn = document.getElementById('resetBtn');
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.prefillEmail();
            }

            setupEventListeners() {
                if (this.form) {
                    this.form.addEventListener('submit', (e) => this.handleSubmit(e));
                }
            }

            prefillEmail() {
                const savedEmail = sessionStorage.getItem('forgot_password_email');
                if (savedEmail) {
                    document.getElementById('email').value = savedEmail;
                    sessionStorage.removeItem('forgot_password_email');
                }
            }

            async handleSubmit(e) {
                e.preventDefault();

                window.authManager.hideAlerts();

                if (!window.authManager.validateForm(this.form)) {
                    window.authManager.showAlert('Prosím zadejte platný e-mail', 'error');
                    return;
                }

                window.authManager.setButtonLoading(this.resetBtn, true);

                try {
                    const formData = window.authManager.getFormData(this.form);
                    formData._token = window.authManager.csrfToken;

                    const response = await fetch('/auth/backend/controllers/PasswordResetController.php?action=request', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: new URLSearchParams(formData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        window.authManager.showAlert(
                            'Odkaz pro obnovení hesla byl odeslán na váš e-mail. Zkontrolujte také složku spam.',
                            'success'
                        );
                        this.form.reset();
                    } else {
                        throw new Error(result.error || 'Odeslání se nezdařilo');
                    }

                } catch (error) {
                    console.error('Password reset error:', error);
                    window.authManager.showAlert(error.message, 'error');
                } finally {
                    window.authManager.setButtonLoading(this.resetBtn, false);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const initForgotPassword = () => {
                if (window.authManager) {
                    window.forgotPasswordManager = new ForgotPasswordManager();
                } else {
                    setTimeout(initForgotPassword, 100);
                }
            };
            
            initForgotPassword();
        });
    </script>
</body>
</html>
